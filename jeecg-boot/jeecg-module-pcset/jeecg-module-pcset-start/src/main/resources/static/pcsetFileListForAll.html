<html>
    <head>
        <meta charset="UTF-8">
        <link rel="stylesheet" href="https://unpkg.com/element-plus/dist/index.css" />
    </head>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <!-- Import component library -->
    <script src="https://unpkg.com/element-plus"></script>
    <body>
        <div id="app">
            <h1>{{titlePath(fileVo)}}</h1>
            <table style="width: 100%;table-layout: fixed;">
                <tr>
                    <td>文件名</td>
                    <td>大小</td>
                    <td>最后更新时间</td>
                    <td>下次次数</td>
                </tr>
                <tr v-show="isShowDirectBack(fileVo)">
                    <td>
                        <span style="color: blue;text-decoration: underline;cursor: pointer;"
                        @click="getBackPackageFileList(fileVo)"
                        >
                            ../
                        </span>
                    </td>
                    <td>-</td>
                    <td>-</td>
                </tr>
                <tr v-for="item in tableData">
                    <td>
                        <span style="color: blue;text-decoration: underline;cursor: pointer;"
                        @click="getPackageFileList(item)"
                        >
                            {{item.name}}
                        </span>
                    </td>
                    <td>
                        {{item.size}}
                    </td>
                    <td>
                        {{item.updateTime}}
                    </td>
                    <td>
                        {{item.downloadCount}}
                    </td>
                </tr>
            </table>
        </div>
    </body>
    <script>
        const {toRef,createApp,ref,onMounted,reactive} = Vue

        createApp({
            setup() {
                    const host = "http://172.30.10.249:9999"
                    //const host = "http://localhost:7010" //win
                    const rootPath = "/home/ftpFileHome/"
                    //const rootPath = "D:\\FtpFileHome\\" //win
                    const relatePath = "PCSet_Release"
                    let path = "";
                    const tableData = ref([])
                    const fileVo = reactive({
                        name: '',
                        updateTime: '',
                        size:'',
                        downloadCount:'',
                        remark:'',
                        relatePath:'',
                        type:''
                    })
                    onMounted(() => {
                        fileVo.relatePath = rootPath + relatePath;
                        fileVo.type = "directory";
                        getPackageFileList(fileVo);
                        isShowDirectBack.value = false;
                    })

                    let titlePath = (item)=>{
                        let resultPath =  item.relatePath.replace(rootPath, '');
                        return resultPath;
                    }

                    const isShowDirectBack = (item)=>{
                        if(item.relatePath == (rootPath + relatePath)) return false;
                        else return true; 
                    }

                    const getBackPackageFileList = (item)=>{
                       let package  = item.relatePath.split(/[\\/]/).filter(Boolean);
                       if (package.length > 1) {
                            package.pop(); // 移除最后一个段
                            //backpackage = package.join('\\');  //win
                            backpackage = '/' + package.join('/'); // 将数组转换回字符串路径
                            item.relatePath = backpackage
                        }
                        getPackageFileList(item)
                    }

                    const getPackageFileList = (item)=>{
                        if(item.type == 'directory'){
                            axios.post(host + '/pcset/file/package/cur/list', {
                                "path": item.relatePath
                            })
                            .then(function (response) {
                                tableData.value = response.data
                                fileVo.relatePath = item.relatePath
                                fielVo.downloadCount = '-'
                            })
                            .catch(function (error) {
                                console.log(error);
                            });
                        }else{
                            axios({
                                method: 'post',
                                url: host + '/pcset/download',
                                data: {
                                    path: item.relatePath
                                },
                                responseType: 'blob',
                                headers: {
                                    'Access-Control-Allow-Origin': '*'
                                }
                            }).then(response => {
                                data = response.data
                                if (!data || data.size === 0) {
                                    alert('文件下载失败');
                                    return;
                                }
                                if (typeof window.navigator.msSaveBlob !== 'undefined') {
                                    window.navigator.msSaveBlob(new Blob([data]), item.name);
                                } else {
                                    let url = window.URL.createObjectURL(new Blob([data]));
                                    let link = document.createElement('a');
                                    link.style.display = 'none';
                                    link.href = url;
                                    link.setAttribute('download', item.name);
                                    document.body.appendChild(link);
                                    link.click();
                                    document.body.removeChild(link); //下载完成移除元素
                                    window.URL.revokeObjectURL(url); //释放掉blob对象
                                }
                            })
                        }
                    }
                    
                return {
                    tableData,
                    path,
                    titlePath,
                    getPackageFileList,
                    isShowDirectBack,
                    fileVo,
                    getBackPackageFileList
                }
            }
        })
        .use(ElementPlus).mount('#app')
    </script>
</html>